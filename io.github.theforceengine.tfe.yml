id: io.github.theforceengine.tfe
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk//23.08
command: io.github.theforceengine.tfe.sh
build-options:
  strip: false
  no-debuginfo: true
separate-locales: false

finish-args:
  # hardware 3D and controller access
  - --device=all
  # X11 + XShm access
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  # Audio
  - --socket=pulseaudio
  # Access to the default Steam Dark Forces data directory for loose, Flatpak and Snap versions of Steam
  - --filesystem=home/.local/share/Steam/steamapps/common/Dark Forces/Game:ro
  - --filesystem=home/.var/app/com.valvesoftware.Steam/.local/share/Steam/steamapps/common/Dark Forces/Game:ro
  - --filesystem=home/snap/steam/common/.local/share/Steam/steamapps/common/Dark Forces/Game:ro

modules:
  - name: tfe
    modules:
      - shared-modules/glu/glu-9.json
      - shared-modules/glew/glew.json
    sources:
      - type: git
        url: https://github.com/luciusDXL/TheForceEngine.git
        tag: v1.10.000
        x-checker-data:
          type: git
          tag-pattern: ^v\\d+(\\.\\d+)+$
      # Separate engine data from user data on Linux by setting PATH_USER_DOCUMENTS to XDG_HOME.
      - type: patch
        path: user_data.patch
      # Patch automatic detection of Dark Forces installation to only check default Steam path
      - type: patch
        path: game_data_detection.patch
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DDISABLE_SYSMIDI=ON
    builddir: true
    post-install:
        # Edit and install desktop launcher file
      - desktop-file-edit --set-key=Exec
                          --set-value="$FLATPAK_ID.sh"
                          "$FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop"
      - install -Dvm 0644
                -t "$FLATPAK_DEST/share/TheForceEngine/Mods/share/metainfo"
                "../TheForceEngine/$FLATPAK_ID.Mod.AdjustableHud.metainfo.xml"
      - appstream-compose --prefix="$FLATPAK_DEST/share/TheForceEngine/Mods"
                          --basename="$FLATPAK_ID.Mod.AdjustableHud"
                          --origin=flatpak
                          "$FLATPAK_ID.Mod.AdjustableHud"
    modules:
      - shared-modules/glu/glu-9.json
      - shared-modules/glew/glew.json

  # Add a wrapper script that points TFE_DATA_HOME to the correct location within the sandbox
  - name: launch_script
    sources:
      - type: file
        path: io.github.theforceengine.tfe.sh
    buildsystem: simple
    build-commands:
      # Install launch script
      - install -Dm 0755 "$FLATPAK_ID.sh" -t "$FLATPAK_DEST/bin"

cleanup-commands:
  - rm -vf "$FLATPAK_DEST/share/metainfo/$FLATPAK_ID.Mod.AdjustableHud.metainfo.xml"

add-extensions:
  # TFEâ€™s mod extension point
  io.github.theforceengine.tfe.Mod:
    directory: share/TheForceEngine/Mods
    merge-dirs: .
    no-autodownload: true
    autodelete: false
    bundle: false
    subdirectories: true
  # AdjustableHud mod bundled with TFE
  io.github.theforceengine.tfe.Mod.AdjustableHud:
    directory: share/TheForceEngine/Mods
    no-autodownload: false
    autodelete: true
    bundle: true
    subdirectories: false
